<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport"
  content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#006400">
  <title><%= title %></title>

  <link rel="icon" type="image/png" href="/admin/assets/img/logo-icon.png" sizes="32x32">
  <link rel="apple-touch-icon" sizes="180x180" href="/admin/assets/img/logo-icon.png">
  <link rel="stylesheet" href="/admin/assets/css/style.css">
  <link rel="manifest" href="/admin/__manifest.json">
  <!-- Additional Scripts -->
  <script type="module" src="https://unpkg.com/ionicons%405.0.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule="" src="https://unpkg.com/ionicons%405.0.0/dist/ionicons/ionicons.js"></script>
</head>

<body>

  <input type="hidden" value="<%= JSON.stringify(itemDetails)%>" id="itemDetails">
  <input type="hidden" value="<%= overallTotal%>" id="overallTotal">

  <!-- loader -->
  <div id="loader" style="background-color: #006400">
    <div class="spinner-grow text-secondary" role="status"></div>
  </div>
  <!-- * loader -->

  <!-- App Header -->
  <div class="appHeader bg-success text-light">
    <div class="left">
      <a href="#" class="headerButton" data-toggle="modal" data-target="#sidebarPanel">
        <ion-icon name="menu-outline"></ion-icon>
      </a>
    </div>
    <div class="pageTitle">
      <%= title %>
    </div>
    <div class="right">
    </div>
  </div>
  <!-- * App Header -->

  <!-- App Capsule -->
  <div id="appCapsule">
    
    <!-- TOASTBOXES -->
    <div>
    <div id="toastSuccessTop" class="toast-box toast-top bg-success tap-to-close">
      <div class="in">
        <div class="text" id="toastSuccessTextTop"></div>
      </div>
      <button type="button" class="btn btn-sm btn-text-light close-button">OKAY</button>
    </div>

    <div id="toastProcessing" class="toast-box toast-center">
      <div class="in">
        <div class="text" id="toastProcessingText">
          <div class="spinner-border text-light" role="status"></div>
          <br><br>
          Please wait...
        </div>
      </div>
    </div>

    <div id="toastSuccess" class="toast-box toast-center bg-success tap-to-close">
      <div class="in">
        <div class="text" id="toastSuccessText"></div>
      </div>
      <button type="button" class="btn btn-sm btn-text-light close-button">OKAY</button>
    </div>

    <div id="toastError" class="toast-box toast-center bg-danger">
      <div class="in">
        <div class="text" id="toastErrorText"></div>
      </div>
      <button type="button" class="btn btn-sm btn-text-light close-button">OKAY</button>
    </div>
    </div>
    <!-- * TOASTBOXES -->

    <div class="section full m-2">
      <button class="btn btn-success btn-block rounded shadowed" onclick="window.location = '/scanner'">Open Scanner</button>
    </div>

    <div class="section full m-2">
      <button class="btn btn-danger btn-block rounded shadowed" onclick="window.location = '/records/12345'">Open Records</button>
    </div>

    <div class="section inset">
      <div class="section-title medium">Overall Records</div>
      <div class="wide-block pt-2 pb-2 text-center">
        <h3 id="dateNow"></h3>
        <h5>Overall PX Credit</h5>
        <h2 id="total"></h2>
      </div>
    </div>

    <div class="section inset">
      <div class="section-title medium">Top Selling Items</div>
      <div class="wide-block pt-2 pb-2">
        <ul id="topselling" class="listview image-listview" style="display: none;"></ul>
        <button class="btn btn-block btn-primary rounded shadowed mt-1" id="showtopsellingBtn">Show Top Selling Items</button>
      </div>
    </div>

  </div>
  <!-- * App Capsule -->

  <!-- App Sidebar -->
  <div class="modal fade panelbox panelbox-left" id="sidebarPanel" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content" style="max-width: 250px;">
        <div class="modal-body p-0" style="max-width: 250px;">
          
          <div class="profileBox pt-2 pb-2">
            <div class="in" style="color: white;">
              <strong>6CAV PX MENU</strong>
            </div>
            <a href="#" class="btn btn-link btn-icon sidebar-close text-success" data-dismiss="modal">
              <ion-icon name="close-outline"></ion-icon>
            </a>
          </div>

          <ul class="listview flush transparent no-line image-listview">
            <li>
              <a href="/scanner" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="scan-outline"></ion-icon>
                </div>
                <div class="in">
                  Open Scanner
                </div>
              </a>
            </li>
            <li>
              <a href="/records/12345" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="book-outline"></ion-icon>
                </div>
                <div class="in">
                  Open Records
                </div>
              </a>
            </li>
            <li onclick="window.location = '/balancesheet'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="document-outline"></ion-icon>
                </div>
                <div class="in">
                  Balance Sheet Public
                </div>
              </a>
            </li>
            <div class="sidebar-balance bg-success">
              <div class="listview-title">
                PX Admin Tools
              </div>
            </div>
            <li onclick="window.location = '/balancesheet_'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="document-outline"></ion-icon>
                </div>
                <div class="in">
                  Balance Sheet Admin
                </div>
              </a>
            </li>
            <li onclick="window.location = '/inventory'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="list-outline"></ion-icon>
                </div>
                <div class="in">
                  Inventory
                </div>
              </a>
            </li>
            <li>
              <a href="/accountabilities" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="card-outline"></ion-icon>
                </div>
                <div class="in">
                  Accountabilities
                </div>
              </a>
            </li>
            <li onclick="window.location = '/adminnotifications'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="notifications-outline"></ion-icon>
                </div>
                <div class="in">
                  Notifications and Orders
                </div>
              </a>
            </li>
            <li onclick="window.location = '/remoteusers'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="people-outline"></ion-icon>
                </div>
                <div class="in">
                  Online Clients
                </div>
              </a>
            </li>
            <li onclick="window.location = '/notify'">
              <a href="#" class="item">
                <div class="icon-box bg-success">
                  <ion-icon name="notifications-outline"></ion-icon>
                </div>
                <div class="in">
                  Notify Clients
                </div>
              </a>
            </li>
          </ul>

        </div>
      </div>
    </div>
  </div>
  <!-- * App Sidebar -->

  <script src="/__/firebase/9.2.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/9.2.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/9.2.0/firebase-database-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.4/axios.min.js" integrity="sha512-lTLt+W7MrmDfKam+r3D2LURu0F47a3QaW5nF0c6Hl0JDZ57ruei+ovbg7BrZ+0bjVJ5YgzsAWE+RreERbpPE1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script type="text/javascript">
    // VARIABLES
    var db = firebase.database();
    const toastSuccessText = document.getElementById('toastSuccessText');
    const toastErrorText = document.getElementById('toastErrorText');

    var total;
    var itemsSold;
    var itemDetails = Object.values(JSON.parse(document.getElementById('itemDetails').value));
    var overallTotal = document.getElementById('overallTotal').value;

    window.addEventListener('DOMContentLoaded', () => {
      var d = new Date();
      document.getElementById('dateNow').innerText = `${d.getDate()} ${getMonthName(d.getMonth())} ${d.getFullYear()}, ${getDayName(d.getDay())}`;
      document.getElementById('total').innerText = `₱ ${numberWithCommas(overallTotal)}`;
    });

    // LISTENERS
    document.getElementById('showtopsellingBtn').addEventListener('click', () => {
      document.getElementById('topselling').style.display = 'block';
      document.getElementById('showtopsellingBtn').style.display = 'none';
      db.ref('Records').once('value').then(snapshot => {
        if(snapshot.val() != null) {
          total = 0;
          itemsSold = [];
          var myrecords = Object.values(snapshot.val());
          myrecords.forEach(rec => {
            if(rec.paid == 'no' && rec.sn != 'Corpo') {
              total += parseInt(rec.total);
            }
            if(rec.corpo == 'no') {
              itemsSold = itemsSold.concat(rec.items);
            }
          });
          
          document.getElementById('total').innerText = `₱ ${numberWithCommas(total)}`;
          
          var sortedItemsSold = sortItems(simplifyArray(itemsSold));
          document.getElementById('topselling').innerText = '';
          var objKeys = Object.keys(sortedItemsSold);
          objKeys.forEach(objKey => {
            var objVal = sortedItemsSold[objKey];
            insertItems(getItemDetails(objKey), objVal);
          });
        }
      }, err => {
        console.log(err);
      });
      
    });
    

    // FUNCTIONS
    function insertItems(itemData, totalPurchased) {
      if(totalPurchased > 50) {
        var li = document.createElement('li');
        var itemDiv = document.createElement('div');
        itemDiv.setAttribute('class', 'item');
        var itemImg = document.createElement('img');
        itemImg.setAttribute('class', 'imaged w48 square');
        itemImg.setAttribute('src', dropboxURL(itemData.image));
        var inDiv = document.createElement('div');
        inDiv.setAttribute('class', 'in');
        var itemNameDiv = document.createElement('div');
        itemNameDiv.innerText = itemData.name;
        var totalDiv = document.createElement('h3');
        totalDiv.innerText = totalPurchased;
  
        // APPEND
        inDiv.appendChild(itemNameDiv);
        inDiv.appendChild(totalDiv);
        itemDiv.appendChild(itemImg);
        itemDiv.appendChild(inDiv);
        li.appendChild(itemDiv);
        document.getElementById('topselling').appendChild(li);
      }
    }

    function getItemDetails(id) {
      var theItem = itemDetails.filter(i => i.id == id);
      if(theItem[0] != undefined) {
        return {
          image: theItem[0].image,
          name: theItem[0].name
        };
      } else {
        return {
          image: 'https://www.dropbox.com/s/daz4b35e8part1l/defaultimage.png?dl=0',
          name: 'Item'
        };
      }
    }

    function dropboxURL(link) {
      var base = link.split('?')[0];
      var fileId = base.split('/')[4];
      var fileName = base.split('/')[5]; 
      return `https://dl.dropboxusercontent.com/s/${fileId}/${fileName}`;
    }

    function simplifyArray(arr) {
      var votingPrecinct = {};
      var candidates = getItemNames(arr);
      candidates.forEach(c => {
        votingPrecinct[c] = 0;
      });
      var data = processItemsSold(arr);
      data.forEach(d => {
        // get the old value
        var oldVal = votingPrecinct[Object.keys(d)[0]];
        votingPrecinct[Object.keys(d)[0]] = oldVal + Object.values(d)[0];
      });
      return votingPrecinct;
    }

    function processItemsSold(items) {
      var soldItems = [];
      items.forEach(item => {
        soldItems.push(separateValues(item));
      });
      return soldItems;
    }

    function separateValues(str) {
      var data = str.split('|');
      var result = {};
      result[`${data[0].replace(/\s/g, '')}`] = parseInt(data[1]);
      return result;
    }

    function getItemNames(items) {
      var result = [];
      items.forEach(item => {
        var data = item.split('|');
        result.push(data[0].replace(/\s/g, ''));
      });
      return [...new Set(result)];
    }

    function sortItems(obj) {
      const sortable = Object.entries(obj)
      .sort(([,b],[,a]) => a-b)
      .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
      return sortable;
    }

    function unixToDate(unixDate) {
      var d = new Date(unixDate);
      return `${d.getDate()}-${getMonthName(d.getMonth())}-${d.getFullYear().toString().substr(-2)}<br>${(d.getHours() <= 9) ? `0${d.getHours()}` : d.getHours()}:${d.getMinutes() <= 9 ? `0${d.getMinutes()}` : d.getMinutes()}`;
    }

    function getMonthName(monthNum) {
      switch (monthNum) {
        case 0: return 'Jan'; break;
        case 1: return 'Feb'; break;
        case 2: return 'Mar'; break;
        case 3: return 'Apr'; break;
        case 4: return 'May'; break;
        case 5: return 'Jun'; break;
        case 6: return 'Jul'; break;
        case 7: return 'Aug'; break;
        case 8: return 'Sep'; break;
        case 9: return 'Oct'; break;
        case 10: return 'Nov'; break;
        case 11: return 'Dec'; break;
      }
    }
    
    function getDayName(dayNum) {
      switch (dayNum) {
        case 1: return 'Monday'; break;
        case 2: return 'Tuesday'; break;
        case 3: return 'Wednesday'; break;
        case 4: return 'Thursday'; break;
        case 5: return 'Friday'; break;
        case 6: return 'Saturday'; break;
        case 0: return 'Sunday'; break;
      }
    }
    
    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
  </script>

  <!-- Jquery -->
  <script src="/admin/assets/js/lib/jquery-3.4.1.min.js"></script>
  <!-- jQuery Circle Progress -->
  <script src="/admin/assets/js/plugins/jquery-circle-progress/circle-progress.min.js"></script>
  <!-- Owl Carousel -->
  <script src="/admin/assets/js/plugins/owl-carousel/owl.carousel.min.js"></script>
  <!-- Bootstrap-->
  <script src="/admin/assets/js/lib/bootstrap.min.js"></script>
  <!-- Popper-->
  <script src="/admin/assets/js/lib/popper.min.js"></script>
  <!-- Base Js File -->
  <script src="/admin/assets/js/base.js"></script>

</body>
</html>